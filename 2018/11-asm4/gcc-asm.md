# Встроенный ассемблер компилятора gcc

Компиляторы языков Си и Си++ в составе GCC позволяют вставлять инструкции языка ассемблера в тело функции на языке высокого уровня.
В ассемблерной вставке можно использовать специальные символы подстановки, которые будут заменены на аргументы из языка высокого уровня.

Ассемблерная вставка имеет вид:
```
    asm(TEMPLATE : OUTPUTS : INPUTS : CLOBBERS);
```

Элементы внутри скобок разделяются символом ':' (двоеточие). OUTPUTS, INPUTS или CLOBBERS могут отсутствовать. Если пропускается
элемент в конце конструкции, то лишние ':' можно не писать.

TEMPLATE - это строка-шаблон, в которой специальные символы подстановки начинаются со знака '%' (процент). Если символ процента
нужен в самой ассемблерной вставке, его нужно записать дважды. То есть, для записи имени регистра процент нужно указать дважды.
Шаблон записывается по правилам записи строки в Си, если шаблон содержит несколько инструкций, их можно разделить символом \n.
Например,
```
    asm("movl $1, %%eax\n"
        "movl globvar, %%edx\n"
        "addl %%edx, %%eax\n"
        "movl %%eax, globvar\n");
```

Встроенного ассемблера, который не взаимодействует с объемлющей этот фрагмент функцией на языке высокого уровня,
как правило, достаточно только для самых тривиальных случаев.

Для получения результата вычислений, передачи параметров и спецификации побочных эффектов используются элементы OUTPUTS, INPUTS, CLOBBERS.

В элементе CLOBBERS перечисляются регистры процессора, которые используются в фрагменте на ассемблере. Как следствие,
компилятор не предполагает, что значение этих регистров осталось неизменным. Для фрагмента на ассемблере, приведенного выше,
следует добавить спецификацию используемых регистров следующим образом:
```
    asm("movl $1, %%eax\n"
        "movl globvar, %%edx\n"
        "addl %%edx, %%eax\n"
        "movl %%eax, globvar\n" : : : "%eax", "%edx");
```

Каждый используемый регистр записывается в символьной строке, строки разделяются запятой.

В элементе OUTPUTS перечисляются спецификации для сохранения результата вычисления.
Спецификация имеет вид `SPEC (LVALUE)`. Здесь SPEC - это строка, специфицирующая способ доступа,
LVALUE - адресуемое выражение языка высокого уровня, в которое будет сохранен результат вычисления.
В частности, спецификация "=g" означает, что на месте LVALUE может находиться любое адресуемое
выражение языка Си, и это LVALUE будет модифицировано. Например, спецификация `"=g" (x)`
означает, что результат вычисления будет записан в переменную `x`.
Спецификация `"+g"` означает, что LVALUE будет и считано, и записано.

Использование спецификаций записывается в виде `%N`, где N - последовательный номер спецификации,
начиная с 0, в списке спецификаций OUTPUTS и INPUTS. То есть, первая спецификация OUTPUTS записывается
в ассемблерной вставке как `%0`. Например, следующий фрагмент сохраняет результат вычисления
выражения не в глобальную переменную `globvar`, а в локальную переменную `result`.

```
    int result;
    asm("movl $1, %%eax\n"
        "movl globvar, %%edx\n"
        "addl %%edx, %%eax\n"
        "movl %%eax, %0\n" : "=g" (result) : : "%eax", "%edx");
```

В элементе INPUTS перечисляются спецификации входных параметров для ассемблерной вставки.
Спецификация имеет вид `SPEC (RVALUE)`. Здесь SPEC - это строка, специфицирующая способ доступа,
RVALUE - выражение языка высокого уровня, значение которого будет передано в ассемблерную вставку.
Спецификация "g" означает, что на месте RVALUE может находиться более-менее любое выражение.

Модифицируем предыдущий пример, чтобы вместо глобальной переменной `globvar` использовалось
заданное выражение.

```
    int param;
    int result;
    asm("movl $1, %%eax\n"
        "movl %1, %%edx\n"
        "addl %%edx, %%eax\n"
        "movl %%eax, %0\n" : "=g" (result) : "g" (param * 10) : "%eax", "%edx");
```

Если в OUTPUTS указана одна спецификация, она в ассемблерной вставке используется как `%0`.
Тогда спецификации из INPUTS будут обозначаться как `%1`, `%2`, ...

## Ссылки

1. [GCC Documentation](https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html)
